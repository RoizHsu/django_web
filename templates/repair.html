{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XXè‚¡ä»½æœ‰é™å…¬å¸-ç¶­ä¿®å–®ç®¡ç†ç³»çµ±</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style260122.css' %}" />
    <link rel="stylesheet" href="{% static 'css/sheet.css' %}">
    <script src="{% static 'js/JavaScript.js' %}"></script>
    <!--vue.js-->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="{% static 'js/faeye.js' %}"></script>
  </head>
  <body class="login-bg">
    <!-- é ‚éƒ¨å°è¦½ -->
    <header>
      <div class="container">
        <nav>
          <!-- å…¬å¸åç¨± -->
          <div class="nav-brand">âœ¨ XXè‚¡ä»½æœ‰é™å…¬å¸ - ç¶­ä¿®å–®ç®¡ç†ç³»çµ±</div>
          
          <!-- å…¶ä»–å°èˆª -->
          <ul>
              <li>
                <a class="meicon nav-link" href="{% url 'index' %}"><img src="{% static 'img/sign.gif' %}" width="30" height="30" />é¦–é å…¬å‘Š</a>
              </li>
              <li>
                <!-- ç§»é™¤å·¢ç‹€ <a>ï¼Œä¸”ä¿®æ”¹meicon nav-link -->
                <a class="meicon nav-link" href="{% url 'repair' %}">
                  <img src="{% static 'img/edit.gif' %}" width="30" height="30" />ç¶­ä¿®å–®
                </a>
              </li>
              <!-- æ–°å¢ä¿®æ”¹ç¶­ä¿®å–®é€£çµ-
            <li>
              <a class="meicon nav-link" href="{% url 'inquire' %}">
                <img src="{% static 'img/checklist.gif' %}" width="30" height="30"/>ä¿®æ”¹ç¶­ä¿®å–®
              </a>
            </li>
             -->
              <li>
                <a class="meicon nav-link" href="#"><img src="{% static 'img/registration.gif' %}" width="30" height="30" />æœå‹™åŠè¯çµ¡æ–¹å¼</a>
              </li>
              <!-- ä½¿ç”¨è€…ç™»å…¥ç™»å‡ºåˆ‡æ› -->
            {% if user.is_authenticated %}
              <li>
                <a class="meicon" id="workspace">
                  <img src="{% static 'img/userform.gif' %}" width="30" height="30" />æ­¡è¿å›ä¾†
                  {{ request.user.profile.user_name|default:request.user.username }}
                </a>
              </li>
              <li class="meicon">
                <img src="{% static 'img/logout.gif' %}" width="30" height="30" />
                <a class="nav-link" href="{% url 'logout' %}">{{ repair.get_repair_user_name }}ç™»å‡º</a>
              </li>
            {% else %}
              <li>
                <a class="meicon" id="workspace">
                  <img src="{% static 'img/dossier.gif' %}" width="30" height="30" /> æ­¡è¿ï¼Œè«‹ç™»å…¥
                  {{ request.user }}
                </a>
              </li>
              <li class="meicon">
                <img src="{% static 'img/logout.gif' %}" width="30" height="30" />
                <a class="nav-link" href="{% url 'login' %}">{{ repair.get_repair_user_name }}ç™»å…¥</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </header>

  <!-- å°èˆªé¸å–® -->

  <div class="nav-container">
    <button id="openWinBtn" class="trigger-btn">æ–°å¢ç¶­ä¿®å–®</button>
      <div class="nav-tabs">
        <div class="time-chip">
          <span class="time-label">æ™‚é–“ï¼š</span>
          <span id="currentTime">è¼‰å…¥ä¸­...</span>
        </div>
          <button class="nav-tab active" data-page="home">ğŸ  ç¶­ä¿®ç´€éŒ„</button>
          <button class="nav-tab" data-page="dashboard">ğŸ“ è³‡æ–™åº«ä¿®æ”¹</button>
          <button class="nav-tab" data-page="calendar">ğŸ“… æ—¥æ­·</button>
      </div>
    </div>
    <!-- å„€è¡¨æ¿ -->
    <section class="page-content active" id="home">
      <div class="content-card">
        <h1>ğŸ“Š ç¶­ä¿®ç´€éŒ„è¡¨</h1>
    <div class="wrap">
      <table id="DataTalbe">
        <thead>
          <tr>
            <th>ç‹€æ…‹</th>
            <th>å–®è™Ÿ</th>
            <th>ç§‘å®¤</th>
            <th>å«ä¿®äºº</th>
            <th>åˆ†æ©Ÿ</th>
            <th>IP</th>
            <th>ç¶­ä¿®æ™‚é–“</th>
            <th>å·¥ç¨‹å¸«</th>
            <th>å ±ä¿®å•é¡Œ</th>
            <th>å›å¾©å ±ä¿®</th>
            <th>ç¶­ä¿®çµæŸ</th>
            <th>æ“ä½œ</th>
          </tr>
            </thead>
        <tbody>
          {% for repair in repairs %}
          <tr>
            <td>{{ repair.state }}</td>
            <td>{{ repair.id }}</td>
            <td>{{ repair.office }}</td>
            <td>{{ repair.name }}</td>
            <td>{{ repair.ext }}</td>
            <td>{{ repair.ip }}</td>
            <td>{{ repair.start }}</td>
            <td>{{ repair.get_repair_user_name }}</td>
            <td>{{ repair.Q }}</td>
            <td>{{ repair.A }}</td>
            <td>{{ repair.finish }}</td>
            <td>
              <a href="{% url 'update' repair.id %}" class="ghost-link">ä¿®æ”¹</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- åˆ†é æ§åˆ¶ -->
    <div id="pagination" class="pagination-controls">
      <button id="prevPage" class="pagination-btn" type="button">ä¸Šä¸€é </button>
      <span id="pageInfo" class="page-info">ç¬¬ 1 é </span>
      <button id="nextPage" class="pagination-btn" type="button">ä¸‹ä¸€é </button>
    </div>
      </div>
    </section>
     

      <!-- æµ®å‹•è¦–çª— -->
  <div id="myWindow" class="window-container">
    <div class="window-header">
      <div class="window-controls">
        <span class="control close" id="closeWinBtn"></span>
        <span class="control minimize"></span>
        <span class="control maximize"></span>
      </div>
      <div class="window-title">æ–°å¢ç¶­ä¿®å–®</div>
    </div>
    <div class="window-content" id="app">
      <h3>æ–°å¢ç¶­ä¿®å–®</h3>
      <p>è«‹ç¢ºèªä¸€ä¸‹è³‡æ–™ç™»æ‰“æ­£ç¢ºã€‚</p>
      <form action="" method="POST">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>{{ repair.ip.label }}ï¼š</label>
            {{ repair.ip }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.ext.label }}ï¼š</label>
            {{ repair.ext }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.name.label }}ï¼š</label>
            {{ repair.name }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.share.label }}ï¼š</label>
            {{ repair.share }}
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>{{ repair.jt.label }}ï¼š</label>
            {{ repair.jt }}
          </div>
          <!--é€™é‚Šé€™è¡Œä¸å¤ªéœ€è¦äº†
          <div class="form-group col-md-6">
            {{ repair.repair_user }}
          </div>-->
          <div class="form-group col-md-6">
            <label>{{ repair.location.label }}ï¼š</label>
            {{ repair.location }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.F.label }}ï¼š</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              {{ repair.F }}
            </div>
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.office.label }}ï¼š</label>
            {{ repair.office }}
          </div>
        </div>
        
        <div class="form-rowQA">
          <div class="form-group col-md-12">
            <label>{{ repair.Q.label }}ï¼š</label>
            {{ repair.Q }}
          </div>
          <div class="form-group col-md-12">
            <label>{{ repair.A.label }}ï¼š</label>
            {{ repair.A }}
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>{{ repair.state.label }}ï¼š</label>
            {{ repair.state }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.start.label }}ï¼š</label>
            {{ repair.start }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.finish.label }}ï¼š</label>
            {{ repair.finish }}
          </div>
        </div>
        
        <div class="form-actions">
          {% csrf_token %}
          <button class="btn btn-primary" type="submit">âœ” å„²å­˜</button>
        </div>
      </form>
    </div>
    <div class="resizer"></div>
  </div>
    <!-- å„€è¡¨æ¿ -->
    <section class="page-content" id="calendar">
      <div class="content-card">
        <h1>ğŸ“… æ—¥æ­·</h1>
        <div id="calendar-app">
          <!-- æ—¥æœŸé¸æ“‡å™¨ -->
          <div class="date-selector">
            <button @click="previousDay" class="date-nav-btn">â—€ å‰ä¸€å¤©</button>
            <div class="current-date">
              <span class="date-display">[[ formatDate(currentDate) ]]</span>
              <input 
                type="date" 
                v-model="currentDateInput" 
                @change="onDateChange"
                class="date-picker"
              />
            </div>
            <button @click="nextDay" class="date-nav-btn">å¾Œä¸€å¤© â–¶</button>
            <button @click="goToday" class="today-btn">ä»Šå¤©</button>
          </div>
          
          <div class="scheduler-container">
            <div class="timeline-header">
              <div class="resource-label">å“¡å·¥ / æ™‚é–“</div>
              <div v-for="h in 24" :key="h" class="time-slot">[[ h-1 ]]:00</div>
            </div>

            <div v-for="emp in filteredEmployees" :key="emp.id" class="employee-row">
              <div class="resource-label">[[ emp.name ]]</div>
              
              <!-- 24å°æ™‚èƒŒæ™¯æ ¼ç·š  å› ç‚ºç¬¬ä¸€åˆ—ç‚ºå“¡å·¥ï¼Œæ™‚é–“è¦å¾ç¬¬äºŒåˆ—é–‹å§‹ æ‰€ä»¥H+1 -->
              <div 
                v-for="h in 24" 
                :key="'grid-'+h" 
                class="grid-cell"
                :style="{ gridColumn: h + 1 }"  
              ></div>
              
              <!-- ç­æ¬¡äº‹ä»¶ -->
              <div 
                v-for="shift in emp.shifts" 
                :key="'shift-'+shift.id"
                class="event-bar"
                :style="getEventStyle(shift)"
                :title="shift.description"
              >
                [[ shift.title ]]
              </div>
            </div>
            
            <div v-if="employees.length === 0" class="no-data">
              <p>æš«ç„¡å“¡å·¥ç­æ¬¡è³‡æ–™</p>
            </div>
            
            <div v-if="filteredEmployees.length === 0 && employees.length > 0" class="no-data">
              <!--<p>ğŸ˜Š é€™å¤©æ²’æœ‰æ’ç­</p>-->
              <p style="font-size: 0.9rem; color: #aaa;">é¸æ“‡å…¶ä»–æ—¥æœŸæŸ¥çœ‹ç­æ¬¡</p>
            </div>
          </div>
        </div>
      </div>
    </section>

<style>
.date-selector {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  padding: 20px;
  background: linear-gradient(135deg, #e6cb83 0%, #f8b465 100%);
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.current-date {
  display: flex;
  align-items: center;
  gap: 10px;
  background: white;
  padding: 10px 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.date-display {
  font-size: 1.2rem;
  font-weight: bold;
  color: #333;
  min-width: 200px;
  text-align: center;
}

.date-picker {
  padding: 8px 12px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 1rem;
  cursor: pointer;
  transition: border-color 0.3s;
}

.date-picker:hover {
  border-color: #667eea;
}

.date-picker:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.date-nav-btn {
  padding: 10px 20px;
  background: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: bold;
  color: #667eea;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.date-nav-btn:hover {
  background: #f8f9fa;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.date-nav-btn:active {
  transform: translateY(0);
}

.today-btn {
  padding: 10px 20px;
  background: #ffd93d;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: bold;
  color: #333;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.today-btn:hover {
  background: #ffc93d;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.scheduler-container {
  display: flex;
  flex-direction: column;
  border: 1px solid #ddd;
  background: white;
  border-radius: 8px;
  overflow: hidden;
}

.timeline-header, .employee-row {
  display: grid;
  grid-template-columns: 150px repeat(24, 1fr);
  border-bottom: 1px solid #eee;
  min-height: 60px;
}

.timeline-header {
  background: #f8f9fa;
  font-weight: bold;
  position: sticky;
  top: 0;
  z-index: 10;
}

.time-slot {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 8px 4px;
  font-size: 0.75rem;
  border-right: 1px solid #e9ecef;
  color: #666;
}

.resource-label {
  background: #f5f5f5;
  padding: 10px;
  font-weight: bold;
  border-right: 2px solid #ddd;
  display: flex;
  align-items: center;
  justify-content: center;
  position: sticky;
  left: 0;
  z-index: 5;
  grid-row: 1;
  grid-column: 1;  /*è¨­å®šèµ·å§‹å’ŒçµæŸä½ç½®*/
}

.employee-row {
  position: relative;
}

.employee-row:hover {
  background-color: #f8f9fa;
}

.grid-cell {
  border-right: 1px solid #f0f0f0;
  grid-row: 1; /*è¨­å®šæ ¼ç·šåœ¨åŒä¸€æ ¼ */
}

.event-bar {
  grid-row: 1;
  margin: 5px 2px;
  padding: 8px;
  color: white;
  border-radius: 4px;
  font-size: 0.85rem;
  z-index: 2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.event-bar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  z-index: 3;
}

.no-data {
  padding: 40px;
  text-align: center;
  color: #999;
  font-size: 1.1rem;
}
</style>

    {% for repair in repairs %}
         
    {% endfor %}

      <!-- æµ®å‹•è¦–çª— - ä¿®æ”¹ç¶­ä¿®å–® -->
  <div id="updateWindow" class="window-container">
    <div class="window-header">
      <div class="window-controls">
        <span class="control close" id="closeUpdateWinBtn"></span>
        <span class="control minimize"></span>
        <span class="control maximize"></span>
      </div>
      <div class="window-title">ä¿®æ”¹ç¶­ä¿®å–®</div>
    </div>
    <div class="window-content">
      <h3>ä¿®æ”¹ç¶­ä¿®å–®</h3>
      <p>è«‹ç¢ºèªä¸€ä¸‹è³‡æ–™ç™»æ‰“æ­£ç¢ºã€‚</p>
      <form action="" method="POST">
        {% csrf_token %}
        
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>{{ repair.ip.label }}ï¼š</label>
            {{ repair.ip }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.ext.label }}ï¼š</label>
            {{ repair.ext }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.name.label }}ï¼š</label>
            {{ repair.name }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.share.label }}ï¼š</label>
            {{ repair.share }}
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>{{ repair.jt.label }}ï¼š</label>
            {{ repair.jt }}
          </div>
          {{ repair.repair_user }}
          <div class="form-group col-md-6">
            <label>{{ repair.location.label }}ï¼š</label>
            {{ repair.location }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.F.label }}ï¼š</label>
            {{ repair.F }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.office.label }}ï¼š</label>
            {{ repair.office }}
          </div>
        </div>
        
        <div class="form-rowQA">
          <div class="form-group col-md-12">
            <label>{{ repair.Q.label }}ï¼š</label>
            {{ repair.Q }}
          </div>
          <div class="form-group col-md-12">
            <label>{{ repair.A.label }}ï¼š</label>
            {{ repair.A }}
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group col-md-6">
            <label>{{ repair.state.label }}ï¼š</label>
            {{ repair.state }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.start.label }}ï¼š</label>
            {{ repair.start }}
          </div>
          <div class="form-group col-md-6">
            <label>{{ repair.finish.label }}ï¼š</label>
            {{ repair.finish }}
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">âœ” å„²å­˜</button>
        </div>
      </form>
    </div>
    <div class="resizer"></div>
  </div>
   


    <script>
      function updateTime() {
        const now = new Date() //æŠ“å–ç•¶ä¸‹æ™‚é–“
      
        //ç²å–å„å€‹æ™‚é–“éƒ¨ä»½
        const year = now.getFullYear() + 'å¹´'
        const month = String(now.getMonth() + 1).padStart(2, '0') + 'æœˆ'
        const day = String(now.getDate()).padStart(2, '0') + 'æ—¥ '
        const hours = String(now.getHours()).padStart(2, '0') + ':'
        const minutes = String(now.getMinutes()).padStart(2, '0') + ':'
        const seconds = String(now.getSeconds()).padStart(2, '0')
        //æ ¼å¼åŒ–æ•¸å­— å°æ–¼10è£œé›¶
        const formattedMinutes = minutes < 10 ? '0' + minutes : minutes
        const formattedSeconds = seconds < 10 ? '0' + seconds : seconds
        //çµ„åˆè¦é¡¯ç¤ºçš„æ™‚é–“
        const timeString = `${year}${month}${day}${hours}${formattedMinutes}${formattedSeconds}`
        //é¡¯ç¤ºåœ¨æŒ‡å®šä½ç½®
        document.getElementById('currentTime').textContent = timeString
      }
      //æ¯ç§’æ›´æ–°ä¸€æ¬¡æ™‚é–“
      setInterval(updateTime, 1000)
      //åˆå§‹å‘¼å«ä¸€æ¬¡ä»¥é¡¯ç¤ºæ™‚é–“
      updateTime()

      // è‡ªå‹•éš±è—è¨Šæ¯ï¼ˆ10ç§’å¾Œï¼‰ å‘¼æ‡‰62-71è¡Œ
      window.addEventListener('DOMContentLoaded', function() {
        const messages = document.querySelectorAll('.alert');
        messages.forEach(function(message) {
          setTimeout(function() {
            message.style.transition = 'opacity 0.5s ease-out';
            message.style.opacity = '0';
            setTimeout(function() {
              message.style.display = 'none';
            }, 500); // æ·¡å‡ºå‹•ç•«0.5ç§’å¾Œå®Œå…¨ç§»é™¤
          }, 5000); // 55ç§’å¾Œé–‹å§‹æ·¡å‡º
        });
      });
      // Vue.js 3 çš„ç¨‹å¼ç¢¼ - è¡¨å–®æ‡‰ç”¨è‡ªå‹•æŠ“å–è³‡æ–™
    const { createApp } = Vue;
    createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                user_material: { name: '', office: '', share: '', ip: '', ext: '' },
                error: false,
                errorMessage: ''
            }
      },
      mounted() {
        const extInput = document.getElementById('id_ext');
        const ipInput = document.getElementById('id_ip');
        const nameInput = document.getElementById('id_name');
        const shareInput = document.getElementById('id_share');
        const officeInput = document.getElementById('id_office');

        this.user_material.ext = extInput ? extInput.value : '';
        this.user_material.ip = ipInput ? ipInput.value : '';
        this.user_material.name = nameInput ? nameInput.value : '';
        this.user_material.share = shareInput ? shareInput.value : '';
        this.user_material.office = officeInput ? officeInput.value : '';
      },
        methods: {
          async fetchEmployeeData(type) {
            const params = new URLSearchParams();

            // æ ¹æ“šè¼¸å…¥çš„é¡å‹ï¼ˆåˆ†æ©Ÿæˆ–IPï¼‰ä¾†æ±ºå®šè¦å‚³é€å“ªå€‹åƒæ•¸
            if (type === 'ext' && this.user_material.ext) {
              params.append('ext', this.user_material.ext);
            }
            if (type === 'ip' && this.user_material.ip) {
              params.append('ip', this.user_material.ip);
            }

            if (!params.toString()) {
              return; // å¦‚æœå…©è€…éƒ½æ²’æœ‰å€¼ï¼Œå°±ä¸ç™¼é€è«‹æ±‚
            }

            // æ³¨æ„é€™è£¡çš„ç¶²å€è¦è·Ÿ urls.py è¨­å®šçš„ä¸€æ¨¡ä¸€æ¨£
            try {
              const response = await fetch(`/repair/get_userMaterial_data?${params.toString()}`);
              const data = await response.json();

              if (data.success) {
                this.user_material.name = data.name;
                this.user_material.office = data.office;
                this.user_material.share = data.share;
                this.user_material.ip = data.ip;
                this.user_material.ext = data.ext;
                this.error = false;
              } else {
                this.user_material = { name: 'æŸ¥ç„¡æ­¤äºº', office: '', share: '', ip: '', ext: '' };
                this.error = true;
                this.errorMessage = 'æ‰¾ä¸åˆ°è©²åˆ†æ©Ÿè³‡æ–™';
              }
            } catch (err) {
              console.error("APIé€£ç·šéŒ¯èª¤", err);
            }
          }
        }
    }).mount('#app');

    // Vue.js 3 çš„ç¨‹å¼ç¢¼ - æ—¥æ›†æ‡‰ç”¨
    createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                employees: [],
                loading: true,
                error: null,
                currentDate: new Date(),
                currentDateInput: ''
            }
        },
        computed: {
            // éæ¿¾å‡ºç•¶å‰æ—¥æœŸçš„ç­æ¬¡
            filteredEmployees() {
                const selectedDate = this.formatDateYMD(this.currentDate);
                
                return this.employees.map(emp => {
                    const filteredShifts = emp.shifts.filter(shift => {
                        const shiftDate = shift.start_time.split(' ')[0];
                        return shiftDate === selectedDate;
                    });
                    
                    return {
                        ...emp,
                        shifts: filteredShifts
                    };
                }).filter(emp => emp.shifts.length > 0);
            }
        },
        mounted() {
            this.currentDateInput = this.formatDateYMD(this.currentDate);
            this.fetchCalendarData();
        },
        methods: {
            async fetchCalendarData() {
                try {
                    const response = await fetch('/register/api/calendar-shifts/');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.employees = data.employees;
                    } else {
                        this.error = data.message || 'ç„¡æ³•è¼‰å…¥æ—¥æ›†è³‡æ–™';
                    }
                } catch (err) {
                    console.error("æ—¥æ›†APIé€£ç·šéŒ¯èª¤", err);
                    this.error = 'è¼‰å…¥æ—¥æ›†è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤';
                } finally {
                    this.loading = false;
                }
            },
            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekday = weekdays[date.getDay()];
                
                return `${year}å¹´${month}æœˆ${day}æ—¥ æ˜ŸæœŸ${weekday}`;
            },
            formatDateYMD(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            previousDay() {
                const newDate = new Date(this.currentDate);
                newDate.setDate(newDate.getDate() - 1);
                this.currentDate = newDate;
                this.currentDateInput = this.formatDateYMD(newDate);
            },
            nextDay() {
                const newDate = new Date(this.currentDate);
                newDate.setDate(newDate.getDate() + 1);
                this.currentDate = newDate;
                this.currentDateInput = this.formatDateYMD(newDate);
            },
            goToday() {
                this.currentDate = new Date();
                this.currentDateInput = this.formatDateYMD(this.currentDate);
            },
            onDateChange() {
                this.currentDate = new Date(this.currentDateInput);
            },
            getEventStyle(shift) {
                // è¨ˆç®—äº‹ä»¶åœ¨ Grid ä¸­çš„ä½ç½®
                const colors = ['#4A90E2', '#50C878', '#FF6B6B', '#FFD93D', '#A78BFA', '#FC7F3C'];
                const colorIndex = shift.id % colors.length;
                
                // Grid column å¾ 2 é–‹å§‹ï¼ˆç¬¬1åˆ—æ˜¯å“¡å·¥åç¨±ï¼‰
                // æ™‚é–“ 0:00 å°æ‡‰ç¬¬ 2 åˆ—ï¼Œæ‰€ä»¥è¦ +2
                const startCol = shift.start_hour + 2;
                const endCol = shift.end_hour + 2;
                
                return {
                    gridColumn: `${startCol} / ${endCol}`,  //ä½¿ç”¨çµ±ä¸€çš„ gridColumn å±¬æ€§
                    backgroundColor: colors[colorIndex]
                };
            }
        }
    }).mount('#calendar-app');
      
    </script>
{% endblock %}

